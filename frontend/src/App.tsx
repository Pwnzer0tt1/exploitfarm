import '@mantine/core/styles.css';
import '@mantine/notifications/styles.css'
import '@mantine/charts/styles.css'
import '@mantine/dates/styles.css';

import { Notifications, notifications } from '@mantine/notifications';
import { AppShell, Box, Container, Divider, Image, LoadingOverlay, MantineProvider, Modal, Space, Title } from '@mantine/core';
import { LoginProvider } from '@/components/LoginProvider';
import { Routes, Route, BrowserRouter } from "react-router-dom";
import { EngineButton, LogoutButton, OptionButton } from '@/components/Buttons';
import { useConnectFailTimeStore, useGlobalStore, useTokenStore } from './utils/stores';
import { statusQuery } from './utils/queries';
import { HomePage } from './components/HomePage';
import { SetupScreen } from './components/SetupScreen';
import { useState } from 'react';

export default function App() {

    const loadingStatus = useGlobalStore((store) => store.loading)
    const setToken = useTokenStore((store) => store.setToken)
    const header = useGlobalStore((store) => store.header)
    const status = statusQuery()
    const isStatusError = useConnectFailTimeStore((state) => state.failed)
    const [openSetup, setOpenSetup] = useState(false)

    return (
        <MantineProvider defaultColorScheme='dark'>
            <Notifications />
            <LoadingOverlay visible={loadingStatus || (!isStatusError && status.isLoading) } zIndex={10} overlayProps={{ radius: "sm", blur: 2 }} />
            <LoginProvider>
                <AppShell
                    header={{ height: 60 }}
                    navbar={{
                        width: 300,
                        breakpoint: 'sm',
                        collapsed: { desktop: true, mobile: true },
                    }}
                >
                    <AppShell.Header>
                        <Box style={{
                            display: "flex",
                            height: "100%",
                            alignItems: "center"
                        }}>
                            <Space w="md" />
                            <Image src="/logo.png" alt="ExploitFarm Logo" width={50} height={50} mih={50} miw={50} style={{marginLeft:5}}/>
                            <Space w="xs" />
                            <Title order={2}>
                                Exploit Farm
                            </Title>
                            <Box style={{ flexGrow: 1 }} />
                            {header}
                            <EngineButton onClick={() => setOpenSetup(true)} />
                            <Space w="md" />
                            <OptionButton onClick={() =>{
                                notifications.show({
                                        title: "Implement me please :(",
                                        message: "This feature is not implemented yet!",
                                        color: "red",
                                        autoClose: 5000
                                })
                            }} />
                            <Space w="md" />
                            {status.data?.config?.AUTHENTICATION_REQUIRED?<>
                                <LogoutButton onClick={() => {
                                    setToken(null)
                                    status.refetch()
                                }} />
                                <Space w="md" />
                            </>:null}
                        </Box>
                    </AppShell.Header>
                    <AppShell.Main>
                    <Container fluid>
                            <BrowserRouter>
                                    <Routes>
                                        <Route path="/" element={<HomePage />} />
                                        <Route path="/:page" element={<HomePage />} />
                                        <Route path="*" element={<Title order={1}>404 Not Found</Title>} />
                                    </Routes>
                            </BrowserRouter>
                            <Divider />
                            <Box className='center-flex' style={{ width: "100%", height:80 }} >
                                <span>Made with ‚ù§Ô∏è and üö© by <a href="https://pwnzer0tt1.it" target='_blank'>Pwnzer0tt1</a></span>
                            </Box>
                            <Divider />

                        </Container>
                        
                        <Modal
                            opened={openSetup}
                            onClose={()=>setOpenSetup(false)}
                            title="Setup Editor ‚öôÔ∏è"
                            centered
                            fullScreen
                            closeOnClickOutside={false}
                        >
                            <SetupScreen editMode onSubmit={()=>setOpenSetup(false)}/>
                        </Modal>
                    </AppShell.Main>
                </AppShell>
            </LoginProvider>
        </MantineProvider>
    )
}
